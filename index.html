<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kasatria Internship Assignment - 3D Visualization</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Three.js and addons -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>

  <!-- TWEEN.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>

  <style>
    body { margin:0; overflow:hidden; background:#000; color:#fff; font-family: Helvetica, sans-serif; }
    #login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:#111; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:100; }
    #container { display:none; }
    #menu { position:absolute; bottom:20px; width:100%; text-align:center; display:none; }
    button { color: rgba(127,255,255,0.75); background: transparent; border: 1px solid rgba(127,255,255,0.75); padding: 8px 15px; cursor: pointer; margin: 5px; font-size: 11px; }
    button:hover { background-color: rgba(0,255,255,0.5); }

    /* Tile style */
    .element { width:140px; height:180px; box-shadow: 0px 0px 12px rgba(0,255,255,0.5); border: 1px solid rgba(127,255,255,0.25); text-align:center; cursor:default; position:relative; }
    .element .name { position:absolute; top:10px; width:100%; font-size:11px; font-weight:bold; color:#fff; text-transform:uppercase; }
    .element .photo { position:absolute; top:35px; left:20px; width:100px; height:100px; border-radius:50%; border:2px solid #fff; object-fit:cover; background:#222; }
    .element .details { position:absolute; bottom:10px; width:100%; font-size:10px; color:#eee; line-height:1.2; }
  </style>
</head>
<body>

  <!-- Login Screen -->
  <div id="login-overlay">
    <h1 style="margin-bottom:20px;">Sign In With Google</h1>
    <p style="color:#888; margin-bottom:30px;">Welcome Back! Please login to continue.</p>
    <div class="g_id_signin"></div>
  </div>

  <!-- 3D Container -->
  <div id="container"></div>

  <!-- Menu Buttons -->
  <div id="menu">
    <button id="table">TABLE (20x10)</button>
    <button id="sphere">SPHERE</button>
    <button id="helix">DOUBLE HELIX</button>
    <button id="grid">GRID (5x4x10)</button>
    <button id="pyramid">PYRAMID</button>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { TrackballControls } from 'three/addons/controls/TrackballControls.js';
    import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';

    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQh16WP5uhuo9GmWBZC7ojq5yLAnCEhaZT6qtHKZxK0hwnZ-jmWYMvTd-PT8cIMDgutJxC2jJI6aJm0/pub?output=csv';

    let camera, scene, renderer, controls;
    const objects = [];
    const targets = { table: [], sphere: [], helix: [], grid: [], pyramid: [] };


    // ---------------- Google Login ----------------
    window.onload = function() {
      google.accounts.id.initialize({
        client_id: "674715063491-k6n894r4p9etin5629fa24kgba73d6hj.apps.googleusercontent.com",
        callback: handleCredentialResponse
      });
      google.accounts.id.renderButton(
        document.getElementsByClassName("g_id_signin")[0],
        { theme: "outline", size: "large" }
      );
      google.accounts.id.prompt();
    };

    function handleCredentialResponse(response) {
      console.log("JWT ID token:", response.credential);
      alert("Login berjaya!");

      document.getElementById('login-overlay').style.display = 'none';
      document.getElementById('container').style.display = 'block';
      document.getElementById('menu').style.display = 'block';

      loadData();
    }

    // ---------------- Load CSV Data ----------------
    async function loadData() {
      try {
        const res = await fetch(SHEET_CSV_URL);
        const csvText = await res.text();
        const lines = csvText.split('\n').slice(1);
        const data = lines.map(line => line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.replace(/"/g,'').trim())).filter(item => item.length>=6);
        init(data);
        animate();
      } catch(err) {
        console.error("Data fetch error:", err);
        alert("Gagal memuatkan data. Pastikan link CSV sah.");
      }
    }

    // ---------------- Init 3D Scene ----------------
    function init(data) {
      camera = new THREE.PerspectiveCamera(40, window.innerWidth/window.innerHeight, 1, 10000);
      camera.position.z = 4000;
      scene = new THREE.Scene();

      data.forEach((item, i) => {
        const [name, photo, age, country, interest, netWorthStr] = item;
        const netWorth = parseFloat(netWorthStr.replace(/[$,]/g,''));

        const element = document.createElement('div');
        element.className = 'element';
        element.style.backgroundColor = netWorth < 100000 ? 'rgba(239,48,34,0.75)' : netWorth > 200000 ? 'rgba(0,255,0,0.75)' : 'rgba(255,165,0,0.75)';

        element.innerHTML = `
          <div class="name">${name}</div>
          <img class="photo" src="${photo}" onerror="this.src='https://via.placeholder.com/100?text=No+Image'">
          <div class="details">${country} | Age: ${age}<br>${interest}<br><b>${netWorthStr}</b></div>
        `;

        const objectCSS = new CSS3DObject(element);
        objectCSS.position.set(Math.random()*4000-2000, Math.random()*4000-2000, Math.random()*4000-2000);
        scene.add(objectCSS);
        objects.push(objectCSS);

        const objTable = new THREE.Object3D();
        objTable.position.x = ((i % 20)*180)-1700;
        objTable.position.y = -(Math.floor(i/20)*210)+900;
        targets.table.push(objTable);
      });

      const vector = new THREE.Vector3();

      for(let i=0,l=objects.length;i<l;i++){
        const phi=Math.acos(-1+(2*i)/l);
        const theta=Math.sqrt(l*Math.PI)*phi;
        const object=new THREE.Object3D();
        object.position.setFromSphericalCoords(900,phi,theta);
        vector.copy(object.position).multiplyScalar(2);
        object.lookAt(vector);
        targets.sphere.push(object);
      }

      for(let i=0,l=objects.length;i<l;i++){
        const theta=i*0.175+(i%2===0?0:Math.PI);
        const y=-(i*10)+600;
        const object=new THREE.Object3D();
        object.position.setFromCylindricalCoords(1000,theta,y);
        vector.x=object.position.x*2;
        vector.y=object.position.y;
        vector.z=object.position.z*2;
        object.lookAt(vector);
        targets.helix.push(object);
      }

      for(let i=0;i<objects.length;i++){
        const object=new THREE.Object3D();
        object.position.x=((i%5)*400)-800;
        object.position.y=(-(Math.floor(i/5)%4)*450)+700;
        object.position.z=(Math.floor(i/20))*-1000+1000;
        targets.grid.push(object);
      }

      const radius = 800;

      const pyramidPositions = [
        new THREE.Vector3( 1,  1,  1),
        new THREE.Vector3(-1, -1,  1),
        new THREE.Vector3(-1,  1, -1),
        new THREE.Vector3( 1, -1, -1),
      ];

      pyramidPositions.forEach(p => p.normalize().multiplyScalar(radius));

      for (let i = 0; i < objects.length; i++) {
        const object = new THREE.Object3D();
        const p = pyramidPositions[i % 4];
        object.position.set(p.x, p.y, p.z);
        object.lookAt(0, 0, 0);
        targets.pyramid.push(object);
      }

      renderer = new CSS3DRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.getElementById('container').appendChild(renderer.domElement);

      controls = new TrackballControls(camera, renderer.domElement);
      controls.addEventListener('change', render);

      document.getElementById('table').addEventListener('click', ()=>transform(targets.table,2000));
      document.getElementById('sphere').addEventListener('click', ()=>transform(targets.sphere,2000));
      document.getElementById('helix').addEventListener('click', ()=>transform(targets.helix,2000));
      document.getElementById('grid').addEventListener('click', ()=>transform(targets.grid,2000));
      document.getElementById('pyramid').addEventListener('click', ()=>transform(targets.pyramid,2000));


      transform(targets.table,2000);
      window.addEventListener('resize', onWindowResize);
    }

    function transform(targets,duration){
      TWEEN.removeAll();
      for(let i=0;i<objects.length;i++){
        const object=objects[i];
        const target=targets[i];
        new TWEEN.Tween(object.position).to({x:target.position.x,y:target.position.y,z:target.position.z},Math.random()*duration+duration).easing(TWEEN.Easing.Exponential.InOut).start();
        new TWEEN.Tween(object.rotation).to({x:target.rotation.x,y:target.rotation.y,z:target.rotation.z},Math.random()*duration+duration).easing(TWEEN.Easing.Exponential.InOut).start();
      }
      new TWEEN.Tween(this).to({},duration*2).onUpdate(render).start();
    }

    function onWindowResize(){
      camera.aspect=window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth,window.innerHeight);
      render();
    }

    function animate(){
      requestAnimationFrame(animate);
      TWEEN.update();
      controls.update();
    }

    function render(){ renderer.render(scene,camera); }

  </script>
</body>
</html>
